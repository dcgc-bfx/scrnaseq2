<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>for_developers</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="for_developers_files/libs/clipboard/clipboard.min.js"></script>
<script src="for_developers_files/libs/quarto-html/quarto.js"></script>
<script src="for_developers_files/libs/quarto-html/popper.min.js"></script>
<script src="for_developers_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="for_developers_files/libs/quarto-html/anchor.min.js"></script>
<link href="for_developers_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="for_developers_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="for_developers_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="for_developers_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="for_developers_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><link rel="stylesheet" href="../css/style.css">
</head>
<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
<li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#directory-structure" id="toc-directory-structure" class="nav-link" data-scroll-target="#directory-structure">Directory structure</a></li>
  <li><a href="#modules" id="toc-modules" class="nav-link" data-scroll-target="#modules">Modules</a></li>
  </ul></nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content"><section id="setup" class="level2"><h2 class="anchored" data-anchor-id="setup">Setup</h2>
<p>First get the code from the git repository.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clone git</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone git@github.com:dcgc-bfx/scrnaseq2.git</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Make sure up-to-date</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> pull</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Use our latest single-cell singularity image (<a href="https://gitlab.hrz.tu-chemnitz.de/dcgc-bfx/singularity/singularity-single-cell/-/releases" class="uri">https://gitlab.hrz.tu-chemnitz.de/dcgc-bfx/singularity/singularity-single-cell/-/releases</a>; v 1.5.4 and higher). Start RStudio and associate a new project with this repository at <em>File</em> -&gt; <em>New</em> <em>Project</em> -&gt; <em>Existing</em> <em>Directory</em> and browse to the path of the git repository.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># run within git directory and create rstudio-server/run and rstudio-server/lib</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># change port</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">singularity</span> run <span class="at">-B</span> /projects,/group <span class="at">-B</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/rstudio-server/run:/var/run/rstudio-server <span class="at">-B</span> <span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span>/rstudio-server/lib:/var/lib/rstudio-server <span class="at">--writable-tmpfs</span>  <span class="at">--app</span> rserver /group/dcgc/sequencing_processed/support/pipeline/singularity/singularity-single-cell_1.5</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">.4.sif</span> 8789</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The RStudio project helps with organizing the files but does not change the git repository itself. Morever, it allows for user-specific settings (see <em>Tools</em> -&gt; <em>Project</em> <em>Options</em>). All RStudio project settings are ignored by git.</p>
<p>Then download the pbmc test dataset. Open the file <code>datasets/10x_pbmc_5k_protein/download.R</code> in RStudio. Then change the working directory with <em>Session</em> -&gt; <em>Set Working Directory</em> -&gt; <em>To Source File Directory</em>. Run the code and files should appear in this directory. Repeat for <code>datasets/10x_pbmc_1k_healthyDonor_v3Chemistry/download.R</code> . Once done, change working directory back to project directory.</p>
<p>Try <em>Build</em> -&gt; <em>Render Book</em>.</p>
</section><section id="directory-structure" class="level2"><h2 class="anchored" data-anchor-id="directory-structure">Directory structure</h2>
<p>Here is a first overview of the directories and files:</p>
<ul>
<li><p><code>scrnaseq.Rproj</code>: RStudio project settings. User-specific. Ignored by git.</p></li>
<li><p><code>scripts</code>: Contains R and quarto scripts which belong to scrnaseq and use parts it code. However, they are stand-alone/independent, not part of the main analysis and typically run from the command line.</p></li>
<li><p><code>references.qmd</code>: Quarto document for printing the bibliography of all references used in scrnaseq.</p></li>
<li><p><code>README.md</code>: Github repository starting page. Currently outdated.</p></li>
<li>
<p><code>R</code>: Contains files with user-defined R functions. Note that they still contain a number of old and not used functions.</p>
<ul>
<li><p><code>general_configuration.R</code>: Contains general settings that are always sourced first.</p></li>
<li><p><code>functions_util.R</code>: Utility functions for general purposes.</p></li>
<li><p><code>functions_plotting.R</code>: Functions to generate common plots.</p></li>
<li><p><code>functions_io.R</code>: Functions for reading and writing data.</p></li>
<li><p><code>functions_degs.R</code>: Functions for DEG analysis. Outdated and not used.</p></li>
<li><p><code>functions_analysis.R</code>: Functions for the analysis of data.</p></li>
<li><p><code>collect_module_results.R</code>: R script. It is run at the end of the analysis and collects all results that should be published to the user.</p></li>
</ul>
</li>
<li><p><code>modules</code>: A analysis consists of different parts (e.g.&nbsp;pre-processing or normalization) that are called modules. Please see the section <em>Modules</em> for more information.</p></li>
<li>
<p><code>misc</code>: Contains various files that cannot be put in another directory.</p>
<ul>
<li><p><code>template.docx</code>: Template for publishing a analysis as Word document.</p></li>
<li><p><code>references.bib</code>: Literature information in BibTex format for citing papers.</p></li>
<li><p><code>nature.csl</code>: Citation style format (currently Nature).</p></li>
</ul>
</li>
<li><p><code>LICENSE</code>: License</p></li>
<li><p><code>index.qmd</code>: Starting page for each report. Supposed to contain information about the biological project/experiment, its questions and TODOs. Also supposed to contain FAQs, Abouts, How to cite etc.</p></li>
<li><p><code>docs</code>: Further documentation to be shown on the github page (Wiki).</p></li>
<li><p><code>datasets</code>: Supposed to contain the datasets to analyse (please put them here). Already contains a number of test datasets (that need to be downloaded first). In addition, there are Excel configuration files for loading the datasets.</p></li>
<li><p><code>css</code>: Contains CSS style sheets for HTML.</p></li>
<li><p><code>.gitignore</code>: Ignore file for git. Set up such that at first all files are ignored and then exceptions are made for the relevant files. This helps with all the temporary files created by R and quarto.</p></li>
<li><p><code>_quarto.yml</code>: Quarto configurations that are always used (knitr options, formats). Always loaded first and then overwritten by additional configurations.</p></li>
<li><p><code>_quarto-default.yml</code>: Quarto configuration file for a specific analysis also called profile with the name <em>default</em>. This could be for example a analysis for scRNA-seq data. Most importantly, the file contains the modules needed to run for this analysis and its required parameters. This allows to have different analysiss for different purposes.</p></li>
<li><p><code>default_book</code>: The final report.</p></li>
</ul></section><section id="modules" class="level2"><h2 class="anchored" data-anchor-id="modules">Modules</h2>
<p>An analysis can be split into individual parts (pre-processing, normalization, etc.), here called modules. The core concept is:</p>
<ul>
<li><p>Modules read some input, do something and store the output for the next modules.</p></li>
<li><p>For the same analysis part, there can be different modules depending on the kinds of data, e.g.&nbsp;normalization for RNA and normalization for ATAC.</p></li>
<li><p>Modules can be chained into an analysis.</p></li>
<li><p>Modules can be run with parameters.</p></li>
</ul>
<p>This has the following advantages:</p>
<ul>
<li><p>Different types of analyses are possible.</p></li>
<li><p>Modules that were already run do not need to be run again which saves sign. time.</p></li>
<li><p>In the final report, each module is a chapter. In the HTML report each module is a separate page. This makes the report more structured.</p></li>
<li><p>Each module is run as separate R session which makes it cleaner and more memory efficient.</p></li>
<li><p>Each module has certain requirements to the input data that must be fulfilled. This allows for independent and parallel development.</p></li>
</ul>
<section id="how-are-modules-chained-into-an-analysis" class="level3"><h3 class="anchored" data-anchor-id="how-are-modules-chained-into-an-analysis">How are modules chained into an analysis</h3>
<p>The first (trivial) possibility is to run each module separately and interactively in RStudio in the desired order.</p>
<p>The intended way however is to define them in an analysis profile yml for quarto. They allow to run quarto with different settings. For example the analysis profile <em>default</em> is defined in the file <code>_quarto-default.yml</code> (<em>default</em> could also be <em>rnaseq</em> or …). This file contains a section <em>chapters</em>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="ex">chapters:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="st">"index.qmd"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="st">"modules/1_read_data/read_data.qmd"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="st">"modules/2_preprocessing/rna/preprocessing.qmd"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="st">"modules/3_normalization/rna/normalization.qmd"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="st">"modules/4_integration/rna/integration.qmd"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-</span> <span class="st">"references.qmd"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>It defines all modules and their order in which they should be run and then included in the report. The modules <code>index.qmd</code> and <code>references.qmd</code> are always included.</p>
<p><strong>Important</strong>: During the development it helps to comment out non-relevant parts as then they will not be rendered.</p>
<p>In addition this configuration file also contains the analysis parameters:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">params:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">general:</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Verbose</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">verbose:</span> true</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Project ID</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">project_id:</span> <span class="st">"pbmc"</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Species</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">species:</span> <span class="st">"homo_sapiens"</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensembl version</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ensembl:</span> 98</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">modules:</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">read_data:</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">paramB:</span> <span class="st">"E"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All parameters in the section <code>general</code> will be applied to all modules but can be overwritten by module-specific settings in the section <code>modules</code>. The module names are used to assign parameters to modules. Furthermore, all parameters defined here overwrite the parameters in the YAML header of the module documents.</p>
</section><section id="how-is-the-analysis-run" class="level3"><h3 class="anchored" data-anchor-id="how-is-the-analysis-run">How is the analysis run</h3>
<p>During development, I would suggest to first run each module manually in RStudio.</p>
<p>Important is to always be in the project directory (since paths are relative to this directory). Use <em>Session</em> -&gt; <em>Set Working Directory</em> -&gt; <em>To Project Directory</em>.</p>
<p>To render the documents, either click the <em>Render</em> button or <em>Build</em>-&gt;<em>Render Book</em>. In both cases, it will run and render all included modules (chapters) in the order defined in the configuration file. At the end, the report will be in separate subdirectory <code>default_book</code> and will be opened by RStudio. The word <em>default</em> here refers to the analysis profile <code>_quarto_default.yml</code>.</p>
</section><section id="how-are-the-results-of-a-module-reused" class="level3"><h3 class="anchored" data-anchor-id="how-are-the-results-of-a-module-reused">How are the results of a module reused</h3>
<p>There are two levels how module results are reused:</p>
<ul>
<li><p>At the end of the R code of a module, the Seurat object is stored in the module directory. The next module loads it and in turn at the end saves a copy. This means that an analysis can be run step by step (and not in a full run anymore). It works both interactively (run code line by line in RStudio) and non-interactive (render via quarto).</p></li>
<li><p>When a module is rendered by quarto, it will run the R code. The result is a markdown file (with text and tables) as well as the plots as PNGs. Quarto then converts these files into the final report. Now quarto can decide whether to run and render a module or re-used the existing content depending on the <code>freeze</code> setting. If in a module <code>freeze</code> is set to <em>yes</em>, then this module will not be run and rendered but its existing content (stored in the directory <code>_freeze</code> ) will be included. If <code>freeze</code> is set to <em>auto</em>, then it will only be run and rendered if the module has changed. <strong>Important</strong>: Even changing some text will cause this. However, other modules that depend on it are not updated automatically so it might lead to inconsistencies. Best is to run a module and once you are happy with it set <code>freeze</code> to <em>yes</em>. <strong>Important:</strong> <code>freeze</code>does not apply when a) you run the code interactively chunk by chunk in RStudio or b) explicitly render this document in RStudio.</p></li>
</ul></section><section id="core-structure-of-a-module" class="level3"><h3 class="anchored" data-anchor-id="core-structure-of-a-module">Core structure of a module</h3>
<p>The code for a module is saved in a sub-directory of the <code>modules</code> directory. Data-type specific variants of the same module are organized in sub-directories, e.g.&nbsp;<code>2_preprocessing/rna/</code> contains the code for pre-processing of RNA data. The actual quarto document is named like the module, e.g.&nbsp;<code>preprocessing.qmd</code> for the preprocessing module.</p>
<p>The quarto document should contain the following core chunks which can be simply copied:</p>
<section id="yaml-header" class="level4"><h4 class="anchored" data-anchor-id="yaml-header">YAML header</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">---</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Module-specific parameters (that are not already in the profile yaml)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">params:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Name of the module used in configurations</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">module:</span> <span class="st">"normalization_rna"</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Relative path to the module directory (which contains the qmd file)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="ex">module_dir:</span> <span class="st">"modules/3_normalization/rna"</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="ex">...</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Module execution</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="ex">execute:</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Should this module be frozen and never re-rendered?</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - auto: if the code has not changed (default)</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># - true/false: freeze/re-render</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Does not apply in interactive mode or when explicitly rendering this document via in rstudio</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="ex">freeze:</span> auto</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="ex">---</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The YAML header contains <strong>defaults</strong> for module-specific parameters. They can (and should be) overwritten in an external analysis-specific configuration file. The only two parameters that need to be defined are <strong>module</strong> (sets the name for the module) and <strong>module_dir</strong> (sets the directory of the module). These identify the module (how to know what module this is) and are required for all module-specific operations.</p>
<p>The <code>freeze</code>setting in the YAML header tells quarto whether to render or freeze the document. If a document is frozen, quarto will always reuse the text and the pictures and will not run the R code.</p>
</section><section id="setup-chunk" class="level4"><h4 class="anchored" data-anchor-id="setup-chunk">Setup chunk</h4>
<p>The setup chunk is special. When you are in a notebook mode, the chunk named setup will be run automatically once, before any other code is run. Therefore, avoid to do computations here and simply used it for general settings and libraries. Furthermore it is always labelled <em>setup</em>.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove the eval setting when using the code</span></span>
<span></span>
<span><span class="co"># If running code interactively in rstudio, set profile here</span></span>
<span><span class="co"># When rendering with quarto, profile is already set and should not be overwritten</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html">nchar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"QUARTO_PROFILE"</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span><span class="st">"QUARTO_PROFILE"</span> <span class="op">=</span> <span class="st">"default"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Source general configurations (always)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/general_configuration.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Source required R functions</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/functions_util.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/functions_io.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/functions_plotting.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/functions_analysis.R"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/">knitr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://gt.rstudio.com">gt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat">Seurat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org">future</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Get module name and directory (needed to access files within the module directory)</span></span>
<span><span class="va">module_name</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">module_name</span></span>
<span><span class="va">module_dir</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">module_dir</span></span>
<span></span>
<span><span class="co"># Parallelisation plan for all functions that support future</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4</span>, gc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<code>QUARTO_PROFILE</code>: When running the code non-interactively (render), there is this environment variable containing the analysis profile name. With this, we know which of the yml configuration files to load. For example for the <em>default</em> workflow, this variable would contain the value <em>default</em> and therefore we load <code>_quarto-default.yml</code>. However when running the code interactively in RStudio (step by step), this is not set and we need to set it manually. This is still a bit hacky but I do not know another way…</li>
<li>Then we source all our functions. In addition, we source general configurations that apply to all R code. Have a look at this file - there are also a few fancy colour palettes…</li>
<li>Then we load packages that need to explicitly loaded. In general, we try to include th package name in the function call though.</li>
<li>Next we get module name and directory.</li>
<li>Finally, we configure how parallelization should be done. This applies to all functions that use the <em>future</em> framework (which most packages incl Seurat do). Four cores is a conservative setting that can be changed depending on function and analysis. I have not had the time to find out…</li>
</ul></section><section id="preparation-chunk" class="level4"><h4 class="anchored" data-anchor-id="preparation-chunk">Preparation chunk</h4>
<p>This chunk loads the input for the module. Furthermore, the input should be checked here. For example, for a module thats find markers, it should be checked whether the input Seurat object has clusters.</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove the eval setting when using the code</span></span>
<span></span>
<span><span class="co">###############</span></span>
<span><span class="co"># Directories #</span></span>
<span><span class="co">###############</span></span>
<span></span>
<span><span class="co"># Module directory 'results' contains all output that should be provided together with the final report of the project</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">module_dir</span>, <span class="st">"results"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">module_dir</span>, <span class="st">"results"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">files</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Module directory 'sc' contains the final Seurat object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">module_dir</span>, <span class="st">"sc"</span><span class="op">)</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">module_dir</span>, <span class="st">"sc"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span><span class="op">(</span><span class="va">files</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#################</span></span>
<span><span class="co"># Seurat object #</span></span>
<span><span class="co">#################</span></span>
<span></span>
<span><span class="co"># Read in seurat object</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="fu">param</span><span class="op">(</span><span class="st">"prev_module_dir"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">prev_module_dir</span> <span class="op">&lt;-</span> <span class="fu">param</span><span class="op">(</span><span class="st">"prev_module_dir"</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">prev_module_dir</span> <span class="op">&lt;-</span> <span class="fu">PreviousModuleDir</span><span class="op">(</span><span class="va">module_dir</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">prev_sc_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">prev_module_dir</span>, <span class="st">"sc"</span>, <span class="st">"sc.rds"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span><span class="op">(</span><span class="va">prev_sc_obj</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="fu">FormatString</span><span class="op">(</span><span class="st">"Could not find a sc.rds file in {{prev_module_dir}}. Was the respective module already run?"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu">SeuratObject</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/SaveSeuratRds.html">LoadSeuratRds</a></span><span class="op">(</span><span class="va">prev_sc_obj</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Move on-disk layers to faster temp location if requested</span></span>
<span><span class="va">on_disk_counts</span> <span class="op">&lt;-</span> <span class="fu">param</span><span class="op">(</span><span class="st">"on_disk_counts"</span><span class="op">)</span></span>
<span><span class="va">on_disk_use_tmp</span> <span class="op">&lt;-</span> <span class="fu">param</span><span class="op">(</span><span class="st">"on_disk_use_tmp"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">on_disk_counts</span> <span class="op">&amp;</span> <span class="va">on_disk_use_tmp</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">on_disk_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://progressr.futureverse.org/reference/with_progress.html">with_progress</a></span><span class="op">(</span></span>
<span>    <span class="op">{</span></span>
<span>      <span class="va">sc</span> <span class="op">&lt;-</span> <span class="fu">UpdateMatrixDirs</span><span class="op">(</span><span class="va">sc</span>, dir <span class="op">=</span> <span class="va">on_disk_path</span><span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    enable <span class="op">=</span> <span class="va">verbose</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="va">on_disk_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">module_dir</span>, <span class="st">"sc"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Set default assay</span></span>
<span><span class="va">default_assay</span> <span class="op">&lt;-</span> <span class="fu">param</span><span class="op">(</span><span class="st">"default_assay"</span><span class="op">)</span></span>
<span><span class="fu">Seurat</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SeuratObject/man/DefaultAssay.html">DefaultAssay</a></span><span class="op">(</span><span class="va">sc</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">default_assay</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>
<p>The first part creates (or cleans) two important sub-directories of the module directory:</p>
<ul>
<li><p><code>results</code>: Contains all files that should be published to the user (tables). Once a report is generated, an R script will copy and organize all files from these directories.</p></li>
<li><p><code>sc</code>: In this directory, the final Seurat object and associated files are saved for the next module.</p></li>
</ul>
</li>
<li><p>Next, it will be determined which of the previous modules should be used as input. This can be set explicitly (<code>prev_module_dir</code>) or is determined by a function that reads the yaml configuration file of the current analysis profile.</p></li>
<li><p>Then the Seurat object is read into memory. If on-disk counts are used, then the Seurat object will contain the paths to the respective directories (which are in the same directory as the Seurat object).</p></li>
<li><p>If on-disk counts are used, performance is better if the counts directories are on a local SSD storage than on a standard disk-based server. They will be copied to a temp directory (e.g.&nbsp;<code>/tmp/Rxsbfhs</code> ) and the Seurat object will be updated. <strong>Problem</strong>: Currently the temp directory is deleted when the R session exists or maybe suspends?</p></li>
<li><p>Finally, the default assay (data type) will be set. For all Seurat functions, it is then not necessary anymore to explicitly specify the assay.</p></li>
</ul></section><section id="analysis-code" class="level4"><h4 class="anchored" data-anchor-id="analysis-code">Analysis code</h4>
<p>Do something.</p>
</section><section id="finish" class="level4"><h4 class="anchored" data-anchor-id="finish">Finish</h4>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove the eval setting when using the code</span></span>
<span></span>
<span><span class="co"># Save Seurat object and layer data</span></span>
<span><span class="fu"><a href="https://progressr.futureverse.org/reference/with_progress.html">with_progress</a></span><span class="op">(</span></span>
<span>  <span class="op">{</span></span>
<span>    <span class="fu">SaveSeuratRds_Custom</span><span class="op">(</span><span class="va">sc</span>,</span>
<span>      outdir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="va">module_dir</span>, <span class="st">"sc"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  enable <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>This chunk saves the updated Seurat object (and if used its on-disk counts matrices).</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Remove the eval setting when using the code</span></span>
<span></span>
<span></span>
<span><span class="co"># Stop multisession workers</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>If parallel workers are used, this will stop them properly.</li>
</ul></section></section></section></main><!-- /main column --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>